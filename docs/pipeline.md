# Pipeline

## 1. Очереди и воркеры

Рекомендуемая схема: единый брокер очередей и специализированные воркеры по типам задач.

**Очереди:**

- ingest
- asr
- segment
- compose
- frames
- export

**Воркеры:**

- IngestWorker
- ASRWorker
- SegmentWorker
- ComposeWorker
- FrameWorker
- ExportWorker

**ML Runtime (локально):**

- ASRWorker умеет запускать Whisper/Vosk по конфигу.
- ComposeWorker умеет вызывать Ollama по локальному API.

## 2. Статусы задач

- `queued`
- `running`
- `success`
- `failed`
- `retrying`

## 3. Ретраи

- Ограниченное число повторов (например, 3).
- Экспоненциальная задержка.
- Перманентные ошибки помечаются как `failed` с причиной.

## 4. Идемпотентность

- Задачи должны быть безопасными при повторном запуске.
- Использовать уникальные ключи (videoId + step) для предотвращения дублей.

## 5. Наблюдаемость

- Логи по каждому этапу.
- Метрики: время ASR, сегментации, кадрирования, экспорта.
- Корреляция задач: `traceId` передается между воркерами.
- Алерты по SLA: рост `failed` и `retrying`, превышение времени обработки.

## 6. Конфигурация провайдеров

- Переключение `asr.provider=local|remote` и `llm.provider=local|remote`.
- Локальные настройки: модель, устройство (cpu/gpu), лимиты памяти.
- Фиксация версии модели и контрольная сумма для воспроизводимости.
- Политика fallback: при ошибке локального провайдера → удаленный (если разрешено).

## 7. Лимиты и квоты

- Максимальная длительность видео проверяется на этапе ingest.
- Ограничение параллельности воркеров по типу задачи.
- Ограничения по количеству активных задач на пользователя.

## 8. Enforcement

- Валидация лимитов на входе API (URL, длительность, квоты).
- Повторная проверка на уровне IngestWorker для надежности.
- Единый формат ошибок `LIMIT_EXCEEDED`.
